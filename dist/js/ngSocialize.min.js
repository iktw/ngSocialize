angular.module('ngSocialize', []);
angular.module('ngSocialize')
    .controller('SocializeYouTubeItemCtrl',
    function ($scope, $log, SocializeYouTubeService, $filter) {
        $scope.youTubeSnippet = null;

        $scope.showVideoModal = function () {
            $scope.youTubeSnippet.isActive = true
        };

        SocializeYouTubeService.getVideoMeta($scope.youTubeId)
            .success(function (data, status, headers, config) {
                $scope.youTubeSnippet = data['items'][0]['snippet'];
                $scope.youTubeSnippet.embedUrl = SocializeYouTubeService.getEmbedUrl($scope.youTubeId);
            })
            .error(function (data, status, headers, config) {
                $log.error(config)
            });
    });

angular.module('ngSocialize')
    .directive('socialize',
    function (SocializeService, SocializeYouTubeService, $compile, $timeout, $templateCache) {

        var socializeApps = SocializeService.getSocialApplications();
        var socializeTemplates = SocializeService.getSocializeTemplates();

        var getSocializeItems = function (urls) {
            var items = {};
            items.youTube = SocializeYouTubeService.getIds(urls);
            return items;
        };

        var generateSocializeTemplate = function (mainTemplate) {
            angular.forEach(socializeApps, function (app) {
                var appTemplateUrl = socializeTemplates[app];
                var appTemplate = $templateCache.get(appTemplateUrl);
                mainTemplate.append(appTemplate);
            })
        };

        var linker = function ($scope, $el) {
            $timeout(function () {
                var innerText = $el[0].innerText;
                var urls = SocializeService.getUrls(innerText);
                var mainTemplate = angular.element('<div>');
                generateSocializeTemplate(mainTemplate);

                $scope.socializeItems = getSocializeItems(urls);

                $compile(mainTemplate)($scope);
                $el.append(mainTemplate);
            }, 0);
        };

        return {
            restrict: 'A',
            link: linker,
            scope: {}
        }
    });

/* This filter is created by https://github.com/sparkalow/angular-truncate */
angular.module('ngSocialize')
    .filter('characters', function () {
        return function (input, chars, breakOnWord) {
            if (isNaN(chars)) return input;
            if (chars <= 0) return '';
            if (input && input.length > chars) {
                input = input.substring(0, chars);

                if (!breakOnWord) {
                    var lastspace = input.lastIndexOf(' ');
                    if (lastspace !== -1) {
                        input = input.substr(0, lastspace);
                    }
                } else {
                    while (input.charAt(input.length - 1) === ' ') {
                        input = input.substr(0, input.length - 1);
                    }
                }
                return input + '...';
            }
            return input;
        };
    });
angular.module('ngSocialize')
    .provider('ngSocialize',
    function () {
        var APIKeys = {
            youTube: ''
        };

        return {
            setYouTubeAPIKey: function (value) {
                APIKeys.youTube = value;
            },
            $get: function () {
                return {
                    youTubeAPIKey: APIKeys.youTube
                }
            }
        }
    });
angular.module('ngSocialize')
    .service('SocializeService', function () {
        return {
            getSocialApplications: function () {
                return [
                    'youTube'
                ];
            },
            getSocializeTemplates: function () {
                return {
                    'youTube': 'ngSocialize/youtube/youtube-list.html'
                }
            },
            clearFromDuplicates: function (list) {
                return list.filter(function (item, pos) {
                    return list.indexOf(item) == pos;
                })
            },
            getUrls: function (text) {
                var regex = /(\b(https?|ftp|file):\/\/[-A-Z0-9&@#\/%?=~_|!:,.;]*[-A-Z0-9&@#\/%=~_|])/ig;
                var urls = [];

                text.replace(regex, function (url) {
                    urls.push(url);
                });

                return urls;
            }
        }
    });

angular.module('ngSocialize')
    .service('SocializeYouTubeService',
    function (SocializeService, $http, ngSocialize) {
        return {
            getVideoMeta: function (id) {
                var api_key = ngSocialize.youTubeAPIKey;
                var url = 'https://www.googleapis.com/youtube/v3/videos?id=' + id + '&part=snippet&key=' + api_key;
                return $http.get(url);
            },
            getEmbedUrl: function (id) {
                return 'http://www.youtube.com/embed/' + id + '?autoplay=1';
            },
            getIds: function (urls) {
                var regex = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.&v=))((\w|-){11})(?:\S)?$/;

                var youtubeIds = [];
                angular.forEach(urls, function (url) {
                    if (url.match(regex)) {
                        youtubeIds.push(RegExp.$1);
                    }
                });

                return SocializeService.clearFromDuplicates(youtubeIds);
            }
        }
    });

angular.module('ngSocialize').run(['$templateCache', function($templateCache) {
    $templateCache.put('ngSocialize/youtube.html',
        "<section class=\"ng-socialize-list-video\" ng-if=\"socializeItems.youTube.length\">\n    <div class=\"ng-socialize-list-item\" ng-show=\"youTubeSnippet\" ng-repeat=\"youTubeId in socializeItems.youTube\" ng-controller=\"SocializeYouTubeItemCtrl\">\n        <div class=\"ng-socialize-list-item-thumbnail\">\n            <div class=\"play_border\">\n                <div class=\"play_button\"></div>\n            </div>\n            <img ng-src=\"{{ youTubeSnippet.thumbnails.default.url }}\">\n        </div>\n        <div class=\"ng-socialize-list-item-content\">\n            <h2 class=\"ng-socialize-list-item-content-title\">{{ youTubeSnippet.title }}</h2>\n\n            <p class=\"ng-socialize-list-item-content-description\" ng-if=\"youTubeSnippet.description\">\n                {{ youTubeSnippet.description | characters:80 }}\n            </p>\n        </div>\n        <small class=\"ng-socialize-list-item-domain\">youtube.com</small>\n    </div>\n</section>\n\n\n<div class=\"video-modal-wrapper\">\n    <div class=\"video-modal-inner\">\n        <iframe width=\"420\" height=\"315\" src=\"http://www.youtube.com/embed/XGSy3_Czz8k?autoplay=1\">\n        </iframe>\n    </div>\n</div>");
}]);
angular.module('ngSocialize').run(['$templateCache', function($templateCache) {
    $templateCache.put('ngSocialize/youtube/youtube-list.html',
        "<section class=\"ng-socialize-list-video\" ng-if=\"socializeItems.youTube.length\">\n    <div class=\"ng-socialize-list-item\" ng-show=\"youTubeSnippet\" ng-repeat=\"youTubeId in socializeItems.youTube\" ng-controller=\"SocializeYouTubeItemCtrl\">\n        <div class=\"ng-socialize-list-item-thumbnail\">\n            <div class=\"play_border\" ng-click=\"showVideoModal()\">\n                <div class=\"play_button\"></div>\n            </div>\n            <img ng-src=\"{{ youTubeSnippet.thumbnails.default.url }}\">\n        </div>\n        <div class=\"ng-socialize-list-item-content\">\n            <h2 class=\"ng-socialize-list-item-content-title\">{{ youTubeSnippet.title }}</h2>\n            <p class=\"ng-socialize-list-item-content-description\" ng-if=\"youTubeSnippet.description\">\n                {{ youTubeSnippet.description | characters:80 }}\n            </p>\n        </div>\n        <small class=\"ng-socialize-list-item-domain\">youtube.com</small>\n        <ng-include src=\"'ngSocialize/youtube/youtube-modal.html'\" ng-if=\"youTubeSnippet.isActive\"></ng-include>\n    </div>\n</section>");
}]);
angular.module('ngSocialize').run(['$templateCache', function($templateCache) {
    $templateCache.put('ngSocialize/youtube/youtube-modal.html',
        "<div class=\"video-modal-wrapper\">\n    <div class=\"video-modal-inner\">\n        <iframe width=\"420\" height=\"315\" src=\"{{ youTubeSnippet.embedUrl }}\"></iframe>\n    </div>\n</div>");
}]);
angular.module('ngSocialize').run(['$templateCache', function($templateCache) {
    $templateCache.put('ngSocialize/youtube/youtube.html',
        "<section class=\"ng-socialize-list-video\" ng-if=\"socializeItems.youTube.length\">\n    <div class=\"ng-socialize-list-item\" ng-show=\"youTubeSnippet\" ng-repeat=\"youTubeId in socializeItems.youTube\" ng-controller=\"SocializeYouTubeItemCtrl\">\n        <div class=\"ng-socialize-list-item-thumbnail\">\n            <div class=\"play_border\">\n                <div class=\"play_button\"></div>\n            </div>\n            <img ng-src=\"{{ youTubeSnippet.thumbnails.default.url }}\">\n        </div>\n        <div class=\"ng-socialize-list-item-content\">\n            <h2 class=\"ng-socialize-list-item-content-title\">{{ youTubeSnippet.title }}</h2>\n\n            <p class=\"ng-socialize-list-item-content-description\" ng-if=\"youTubeSnippet.description\">\n                {{ youTubeSnippet.description | characters:80 }}\n            </p>\n        </div>\n        <small class=\"ng-socialize-list-item-domain\">youtube.com</small>\n    </div>\n</section>\n\n\n<div class=\"video-modal-wrapper\">\n    <div class=\"video-modal-inner\">\n        <iframe width=\"420\" height=\"315\" src=\"http://www.youtube.com/embed/XGSy3_Czz8k?autoplay=1\">\n        </iframe>\n    </div>\n</div>");
}]);